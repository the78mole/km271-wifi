name: KM217-WiFi Build & Documentation Check (ACT Local Test)

on:
  pull_request:
    branches: [ main, workflow-setup ]
    paths:
      - 'KM217-WiFi/**'
      - 'EXTENSIONS/ETH_W5500/**'
      - 'DOC/**'
      - '.github/workflows/**'

permissions:
  contents: read
  actions: read
  pull-requests: write

jobs:
  hardware-build:
    name: 🔧 Hardware Build & Export
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/the78mole/kicaddev-docker:latest
    
    strategy:
      matrix:
        include:
          - name: "KM217-WiFi"
            path: "KM217-WiFi" 
            description: "Main KM217-WiFi Board"
            type: "main"
          - name: "ETH_W5500"
            path: "EXTENSIONS/ETH_W5500"
            description: "Ethernet Extension Board"
            type: "extension"
      fail-fast: false
      
    steps:
    - name: 📥 Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: 🏷️ Generate Semantic Version
      id: semver
      uses: paulhatch/semantic-version@v5.4.0
      with:
        branch: main
        tag_prefix: "v"
        version_format: "${major}.${minor}.${patch}"
        major_pattern: "/^(feat|fix|refactor)!:/"
        minor_pattern: "/^feat:/"
        bump_each_commit: true
        search_commit_body: true

    - name: 🔍 Check for KiCad Changes Since Last Release
      run: |
        ./.github/workflows/scripts/check-kicad-changes-since-release.sh \
          --sha "${GITHUB_SHA}" \
          --ref "${{ github.ref_name }}"
        
    - name: 🗂️ Check KiCad Project Files  
      run: |
        ./.github/workflows/scripts/check-kicad-files.sh \
          --name "${{ matrix.name }}" \
          --path "${{ matrix.path }}" \
          --description "${{ matrix.description }}"
        
    - name: 🧹 Clean Export Directory
      run: |
        ./.github/workflows/scripts/clean-export-dirs.sh \
          --name "${{ matrix.name }}" \
          --path "${{ matrix.path }}" \
          --description "${{ matrix.description }}"
        
    - name: 📐 Export Schematics PDF
      run: |
        ./.github/workflows/scripts/export-schematics.sh \
          --name "${{ matrix.name }}" \
          --path "${{ matrix.path }}" \
          --description "${{ matrix.description }}"
        
    - name: 🔧 Export Gerber Files
      run: |
        ./.github/workflows/scripts/export-gerber.sh \
          --name "${{ matrix.name }}" \
          --path "${{ matrix.path }}" \
          --description "${{ matrix.description }}"
        
    - name: 📄 Export PCB PDF
      run: |
        ./.github/workflows/scripts/export-pcb-pdf.sh \
          --name "${{ matrix.name }}" \
          --path "${{ matrix.path }}" \
          --description "${{ matrix.description }}"
        
    - name: 🖼️ Export PCB Images
      run: |
        ./.github/workflows/scripts/export-pcb-images.sh \
          --name "${{ matrix.name }}" \
          --path "${{ matrix.path }}" \
          --description "${{ matrix.description }}"
        
    - name: 🎯 Export 3D Models
      run: |
        ./.github/workflows/scripts/export-3d-models.sh \
          --name "${{ matrix.name }}" \
          --path "${{ matrix.path }}" \
          --description "${{ matrix.description }}"
        
    - name: 📊 Generate Production Summary
      run: |
        ./.github/workflows/scripts/generate-production-summary-pr.sh \
          --name "${{ matrix.name }}" \
          --path "${{ matrix.path }}" \
          --description "${{ matrix.description }}" \
          --sha "${GITHUB_SHA}" \
          --ref "${{ github.ref_name }}"
        
    - name: 🧪 Validate Export Files
      run: |
        ./.github/workflows/scripts/validate-export-files.sh \
          --name "${{ matrix.name }}" \
          --path "${{ matrix.path }}" \
          --description "${{ matrix.description }}"
        
    - name: 📤 Upload Hardware Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.name }}-hardware-pr-${{ steps.semver.outputs.version }}
        path: |
          ${{ matrix.path }}/Export/
        retention-days: 5
        
  documentation-build:
    name: 📚 Documentation Build
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/the78mole/kicaddev-docker:latest
      
    steps:
    - name: 📥 Checkout Repository
      uses: actions/checkout@v4
      
    - name: 🔍 Check Documentation Files
      run: ./.github/workflows/scripts/check-documentation.sh
        
    - name: 📖 Build AsciiDoc Documentation
      run: ./.github/workflows/scripts/build-asciidoc.sh
        
    - name: 📝 Generate LaTeX Documentation
      run: ./.github/workflows/scripts/build-latex.sh
        
    - name: 🔗 Check Documentation Links
      run: ./.github/workflows/scripts/check-documentation-links.sh
        
    - name: 📊 Documentation Statistics
      run: ./.github/workflows/scripts/generate-documentation-statistics.sh
        
    - name: 📤 Upload Documentation Artifacts
      uses: actions/upload-artifact@v4
      if: env.ACT != 'true'
      with:
        name: Documentation-pr-build
        path: |
          DOC/Output/
        retention-days: 5
